<!-- çº¯VUEå®ç°çš„æ‰«é›· V1.0 -->
<!-- -1:é›· 0-8å‘¨å›´é›·çš„æ•°é‡ 9ä¿æŠ¤æ ‡è®° 10ç–‘é—®æ ‡è®°-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>æ‰«é›·2.0ç‰ˆæœ¬</title>
		<script src="../static/js/vue.js" type="text/javascript" charset="utf-8"></script>
		<script src="../static/js/common/dict.js"></script>
		<script src="../static/js/jquery.min.js"></script>
		<script src="../static/js/layui.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
		<script src="https://unpkg.com/vue-router@3.5.4/dist/vue-router.js"></script>
		<script src="http://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
		<script src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js"></script>
		<link rel="stylesheet" href="../static/css/layui.css" media="all">
		<style>
			.close{
				text-align: center;
				background-color:grey;
				float: left;
				border: black solid 1px;
			}
			.gameBoard{
				position: absolute;
				left:28.5%;
				top:0%;
			}
			#app{
				position: relative;
			}
			.close:hover{
				background-color: cyan;
				transition: all 0.2s ease;
			}
			.open{
				text-align: center;
				background-color:whitesmoke;
				float: left;
				border: black solid 1px;
			}
			.gameinfo{
				color: aquamarine;
				font-size: 22px;
			}
			.saolei{
				color: darkblue;
				font-size: 22px;
			}
			.biaoji{
				color: red;
				font-size: 22px;
			}
			.gameBoardBox{
				height: 675px;
				width: 675px;
				display: block;
			}
			.gamestart{
				position: absolute;
				left:28.5%;
				top:0%;
				height: 675px;
				width: 675px;
				display: block;
				border: 1px blueviolet solid;
			}
			.gameresult{
				position: absolute;
				left:28.5%;
				top:0%;
				height: 675px;
				width: 675px;
				display: block;
				border: 1px blueviolet solid;
			}
			.onlineGameResult{
				position: absolute;
				left:28.5%;
				top:0%;
				height: 675px;
				width: 675px;
				display: block;
				border: 1px blueviolet solid;
			}
			.gameresultinfo{
				color: palevioletred;
				font-size: 35px;
				align-items: center;
				padding: 15px;
				padding-left: 225px;
			}
			.gamestart h1{
				text-align: center;
				color: darkorange;
			}
			.gamestart a p{
				text-align: center;
				font-size: 45px;
			}
			a:link, a:visited{
				text-decoration: none;
			}
			a:hover{
				color:orangered;
			}
			.chooseinfo{
				margin-top: 20px;
				margin-left: -50px;
			}
			[v-cloak]{
				display: none;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<p>ç”¨æˆ·å:{{username}}</p>
			<p>ä¸ªäººç­‰çº§åˆ†:{{rankOwn}}</p>
			<p>ä¸ªäººèƒœå±€æ•°:{{winNumber}}</p>
			<p>ä¸ªäººè´¥å±€æ•°:{{loseNumber}}</p>
			<p>ä¸ªäººæ¸¸æˆæ•°:{{gameNumber}}</p>
			<p>ä¸ªäººå¯¹å±€åˆ†:{{rankBattle}}</p>
			<p>å¯¹å†³èƒœå±€æ•°:{{battleWinNumber}}</p>
			<p>å¯¹å†³è´¥å±€æ•°:{{battleLoseNumber}}</p>
			<p>å¯¹å†³æ¸¸æˆæ•°:{{battleGameNumber}}</p>
			<p>ä¸ªäººèƒœç‡:{{winRate}}%</p>
			<p>å¯¹å†³èƒœç‡:{{battleWinRate}}%</p>
			<p v-cloak>å½“å‰åœ¨çº¿äººæ•°:{{onlinePersonNumber}}</p>
			<p>ç³»ç»Ÿå…¬å‘Š:</p>
			<p>{{systemNotice}}</p>
			<router-view ref="gameRouter"
						 @sendall="sendAll"
						 @loadwaitingforstartbattle = "loadWaitingForStartBattle"
						 @loadwaitingforendbattleonline = "loadWaitingForEndBattleOnline"
						 :username="username"
						 :rankown="rankOwn"
						:rankbattle="rankBattle"></router-view>
		</div>

		<template id="gamestart">
			<div class="gamestart">
				<br><br><br><br><br><br><br><br>
				<br><br><br><br>
<!--				<button>å›åˆ°ä¸»ç•Œé¢</button>-->
<!--				<button>å†æ¥ä¸€æ¬¡</button>-->
				<router-link to="/game"><p>å•äººæ¸¸æˆ</p></router-link>
				<router-link to="/game"><p>æ’è¡Œæ¦œ(ç ”ç©¶ä¸­)</p></router-link>
				<router-link to="/game"><p>å†å²å¯¹å±€(ç ”ç©¶ä¸­)</p></router-link>
				<button @click="doublePlay()"><p>åŒäººæ’ä½(ç ”ç©¶ä¸­)</p></button>
			</div>
		</template>
			
		<template id="gameresult">
			<div class="gameresult">
				<div class="gameresultinfo">æ¸¸æˆç»“æœï¼š{{this.$route.params.gameResult}}</div>
				<div class="gameresultinfo">èƒœè´Ÿå¾—åˆ†:{{this.$route.params.winLoseScore}}</div>
				<div class="gameresultinfo">æ’é›·å¾—åˆ†:{{this.$route.params.mineScore}}</div>
				<div class="gameresultinfo">æ—¶é—´å¾—åˆ†:{{this.$route.params.timeScore}}</div>
				<div class="gameresultinfo">æ ¼å­å¾—åˆ†:{{this.$route.params.boardScore }}</div>
				<div class="gameresultinfo">æœ€ç»ˆå¾—åˆ†:{{this.$route.params.totalScore}}</div>
				<div class="gameresultinfo">ä¸ªäººç­‰çº§åˆ†:{{this.$route.params.originalRank}} -> {{this.$route.params.newRank}}</div>
				<div class="gameresultinfo">å¾—åˆ†æµ®åŠ¨:{{this.$route.params.rankFloat}}</div>
				<div class="chooseinfo">
					<router-link to="/gamestart">å›åˆ°ä¸»ç•Œé¢</router-link>
					<router-link to="/game">å†æ¥ä¸€æ¬¡</router-link>
				</div>
			</div>
		</template>

		<template id="onlineGameResult">
			<div class="onlineGameResult">
				<div>ç”¨æˆ·å:{{this.$route.params.usernameOwn}} VS {{this.$route.params.usernameOther}}</div>
				<div>æ¸¸æˆç»“æœ:{{this.$route.params.gameResultOwn}} VS {{this.$route.params.gameResultOther}}</div>
				<div>èƒœè´Ÿå¾—åˆ†:{{this.$route.params.winLoseScoreOwn}} VS {{this.$route.params.winLoseScoreOther}}</div>
				<div>æ’é›·å¾—åˆ†:{{this.$route.params.mineScoreOwn}} VS {{this.$route.params.mineScoreOther}}</div>
				<div>æ—¶é—´å¾—åˆ†:{{this.$route.params.timeScoreOwn}} VS {{this.$route.params.timeScoreOther}}</div>
				<div>æ ¼å­å¾—åˆ†:{{this.$route.params.boardScoreOwn}} VS {{this.$route.params.boardScoreOther}}</div>
				<div>æœ€ç»ˆå¾—åˆ†:{{this.$route.params.totalScoreOwn}} VS {{this.$route.params.totalScoreOther}}</div>
				<div>å¯¹å±€ç»“æœ:{{this.$route.params.battleResult}}</div>
				<div>ä¸ªäººå¯¹å±€åˆ†:{{this.$route.params.originalRank}} -> {{this.$route.params.newRank}}</div>
				<div>å¾—åˆ†æµ®åŠ¨:{{this.$route.params.rankFloat}}</div>
				<div class="chooseinfo">
					<router-link to="/gamestart">å›åˆ°ä¸»ç•Œé¢</router-link>
				</div>
			</div>
		</template>

		<template id="gameboard">
			<div class="gameBoard">
				<span :class="{saolei : ModeFlag,biaoji : !ModeFlag}">å½“å‰æ¨¡å¼:{{CurrentMsg}} [ç©ºæ ¼é”®åˆ‡æ¢]</span>
				<span class="gameinfo">å‰©ä½™é›·æ•°:{{leftMineNumberPred}}</span>
				<span class="gameinfo">å‰©ä½™æ ¼å­æ•°:{{totalLeft}}</span>
				<span class="gameinfo">ç”¨æ—¶:{{useTime}}ms</span>
				<span class="gameinfo">éš¾åº¦:{{boardLevel}}</span>
				<div class="gameBoardBox">
					<div v-for="(boardRow, rowIndex) in gameBoard" :key="rowIndex"
					:style="[lineStyle]">
						<div v-for="(boardItem, colIndex) in boardRow" :key="boardItem.id"
						@click="ClickBorder(rowIndex, colIndex)"
						:class="{ open: stateBoard[rowIndex][colIndex].state == 1,
									close: stateBoard[rowIndex][colIndex].state != 1}"
						:style="[elemStyle, {color:ColorList[gameBoard[rowIndex][colIndex].elem - 1]}]">
								{{boardItem.elem | showItem(rowIndex, colIndex, stateBoard)}}
						</div>
					</div>
				</div>
			</div>
		</template>
		
		<script>
			console.log("start");
			let layer;
			layui.use(['layer'], function () {
				layer = layui.layer;
			})

			var onlineGameResult = {
				template:"#onlineGameResult"
			}

			var gamestart = {
				template:"#gamestart",
				methods:{
					doublePlay:function (){
						this.$emit
						(
								"sendall",
								messageType.StartBattle,
								"",
						)
						this.$emit("loadwaitingforstartbattle");
					}
				}
			};
			var gameresult = {
				template:'#gameresult'
			};
			var gameboard = {
				template:'#gameboard',
				mounted(){
					let ranks = this.rankown;
					let obj = {rank:ranks, isOnlineBattle:this.$route.params.isOnlineBattle};
					if(obj.isOnlineBattle) {
						this.isOnlineBattle = obj.isOnlineBattle;
						ranks = this.$route.params.boardLevel;
						obj['rank'] = this.$route.params.boardLevel;
						obj['username1p'] = this.$route.params.username1p;
						obj['username2p'] = this.$route.params.username2p;
						obj['isOnlineBattle'] = true;
					}
					else{
						obj['isOnlineBattle'] = false;
					}
					console.log(obj);
					this.$http.post('/board/create', obj).then(function (result){
						this.row = result.body.row;
						this.col = result.body.col;
						this.mineNumber = result.body.mineNumber;
						this.boardLevel = result.body.levelScore;
						this.SyncGameBoard(this.row , this.col, this.mineNumber);
					})
					document.onkeydown = (e) => {
					  let e1 = e || event || window.event || arguments.callee.caller.arguments[0];
					  if (e1 && e1.keyCode === 32) {
						this.changeMode();
					  } 
					}
					window.onbeforeunload = () =>{
						// æ­¤å¤„è°ƒç”¨ä¿å­˜çš„æ–¹æ³•
						if(this.gameState === gameState.start){
							this.loseAction();
						}
						this.gameState = gameState.ready;
					}
				},
				destroyed(){
					clearInterval(this.TimeCounterId);
				},
				props:['username', 'rankown', 'rankbattle'],
				data:function(){
					return {
						gameBoard:[
								[]
						],//å®é™…çš„æ£‹ç›˜æ•°æ®
						stateBoard:[
								[]
						],//å®é™…çš„æ£‹ç›˜çŠ¶å†µ
						row: 0,
						col: 0,
						total: 0,
						totalLeft: 0,//æœªè¢«ç¿»å¼€çš„ä¸ªæ•°
						mineNumber: 0,
						boardLevel: 1500,//æ¸¸æˆéš¾åº¦
						leftMineNumberPred: 0,//é¢„æµ‹å‰©ä½™é›·æ•°
						leftMineNumberTrue: 0,//å®é™…å‰©ä½™é›·æ•°
						gameState:gameState.ready,//readyå‡†å¤‡ start è¿›è¡Œä¸­ fail å¤±è´¥ win æˆåŠŸ
						startTime:0,
						useTime:0,
						TimeCounterId:null,
						elemSize:60,
						elemStyle:{},
						lineStyle:{},
						isOnlineBattle:false,
						ModeFlag:true,//æ‰«é›·æ¨¡å¼true ä¿æŠ¤æ¨¡å¼false
						CurrentMsg:"æ‰«é›·",
						ColorList:["blue", "green", "red", "darkblue", "brown", "cyan", "black", "grey"]
					}
				},
				methods:{
					//ç”Ÿæˆéšæœºçš„é›·
					emblanceMine:function(protectedTag){
						let tempList = [];//è®°å½•å“ªäº›ä½ç½®è¿˜ä¸æ˜¯é›·
						let protectedList =
						[protectedTag - this.col - 1, protectedTag - this.col, protectedTag - this.col + 1,
						protectedTag - 1, protectedTag, protectedTag + 1,
						protectedTag + this.col - 1, protectedTag + this.col, protectedTag + this.col + 1];
						for (let i = 0; i < this.total; i++) {
							if(protectedList.indexOf(i) === -1) {
								tempList.push(i);
							}
						}

						//æŠŠéƒ¨åˆ†æ ¼å­å˜æˆé›·
						for(let i = 0;i < this.mineNumber;i++){
							let tempIndex = Math.floor(Math.random()* tempList.length);
							let trueIndex = tempList[tempIndex];
							tempList.splice(tempIndex, 1);
							this.gameBoard[Math.floor(trueIndex / this.col)][trueIndex % this.col].elem = -1;
						}
					},
					//è®¡ç®—æ¯ä¸ªæ ¼å­å‘¨å›´æœ‰å‡ ä¸ªé›·
					calMineNumber:function(){
						for(let i = 0;i < this.row;i++){
							for(let j = 0;j < this.col;j++){
								this.gameBoard[i][j].elem = this.calPerMineNumber(i, j);
							}
						}
					},
					//è®¡ç®—æŸä¸ªæ ¼å­å‘¨å›´æœ‰å‡ ä¸ªé›·
					calPerMineNumber:function(rowIndex, colIndex){
						if(this.gameBoard[rowIndex][colIndex].elem === -1)
							return -1;
						let dx = [-1,-1,-1,0,0,1,1,1];
						let dy = [-1,0,1,-1,1,-1,0,1];
						let count = 0;
						for(let i = 0;i < 8;i++){
							let tx = dx[i] + rowIndex;
							let ty = dy[i] + colIndex;
							if(tx < 0 || tx >= this.row)
								continue;
							if(ty < 0 || ty >= this.col)
								continue;
							if(this.gameBoard[tx][ty].elem === -1)
								count++;
						}
						return count;
					},
					//æ£‹ç›˜åˆå§‹åŒ–
					SyncGameBoard:function(row, col, mineNumber){
						this.row = row;
						this.col = col;
						this.total = row * col;
						this.mineNumber = mineNumber;
						this.totalLeft = this.total;
						this.leftMineNumberPred = mineNumber;
						this.leftMineNumberTrue = mineNumber;
						this.elemSize = 675 / row - 2;
						this.elemStyle = {height: this.elemSize + "px", 
										  width:this.elemSize + "px",
										  'font-size':this.elemSize * 3 / 4 + "px"};
						this.lineStyle = {height: this.elemSize + "px"};
						this.gameState = gameState.start;
									
						this.LogicProcess();
					},
					LogicProcess:function(protectedTag){
						this.gameBoard = [];
						this.stateBoard = [];
						
						for(let i = 0;i < this.row;i++){
							let tempRow = [];
							let stateRow = [];
							for(let j = 0;j < this.col;j++){
								tempRow.push({elem:0, id:"mine:" + (i * this.col + j)});
								stateRow.push({state:0, id:"mine:" + (i * this.col + j)});
							}
							this.gameBoard.push(tempRow);
							this.stateBoard.push(stateRow);
						}	
						
						this.emblanceMine(protectedTag);
						this.calMineNumber();			
						this.startTimeCounter();
					},
					//è¢«é¼ æ ‡ç‚¹å‡»
					ClickBorder:function(row, col){
						if(this.gameState !== gameState.start){
							return;
						}
						if(this.totalLeft === this.total && this.gameBoard[row][col].elem !== 0){
							this.LogicProcess(row * this.col + col);
						}
						if(this.stateBoard[row][col].state === 1){
							this.QuicklyClear(row, col);
						}
						else if(this.ModeFlag)
							this.ClickLeft(row, col);
						else
							this.ClickRight(row, col);
					},
					//æ‰«é›·æ¨¡å¼
					ClickLeft:function(row, col){
						if(row < 0 || row >= this.row)
							return;
						if(col < 0 || col >= this.col)
							return;
						if(this.stateBoard[row][col].state === 2 || this.stateBoard[row][col].state === 1)
							return;
						this.stateBoard[row][col].state = 1;
						this.totalLeft--;
						if(this.gameBoard[row][col].elem === -1){
							this.gameState = gameState.lose;
							return;
						}
						if(this.totalLeft === this.leftMineNumberTrue){
							this.gameState = gameState.win;
							return;
						}
						let dx = [-1,-1,-1,0,0,1,1,1];
						let dy = [-1,0,1,-1,1,-1,0,1];
						
						if(this.gameBoard[row][col].elem === 0){
							for(let i = 0;i < 8;i++){
								this.ClickLeft(row + dx[i], col + dy[i]);
							}
						}
					},
					//æ’æ——æ¨¡å¼
					ClickRight:function(row, col){
						if(row < 0 || row >= this.row)
							return;
						if(col < 0 || col >= this.col)
							return;
						if(this.stateBoard[row][col].state === 1)
							return;
						if(this.stateBoard[row][col].state === 0){//æ­£å¸¸å˜ä¿æŠ¤ ä¿æŠ¤å˜ï¼Ÿ2>3 ?
							this.stateBoard[row][col].state = 2;
							this.leftMineNumberPred--;
							if(this.gameBoard[row][col].elem === -1)
								this.leftMineNumberTrue--;
							this.totalLeft--;
							return;
						}
						if(this.stateBoard[row][col].state === 2){//æ­£å¸¸å˜ä¿æŠ¤ ä¿æŠ¤å˜ï¼Ÿ2>3 ?
							this.stateBoard[row][col].state = 0;
							this.leftMineNumberPred++;
							if(this.gameBoard[row][col].elem === -1)
								this.leftMineNumberTrue++;
							this.totalLeft++;
						}
					},
					//å¿«é€Ÿæ¸…ç†æ¨¡å¼
					QuicklyClear:function(row, col){
						let dx = [-1,-1,-1,0,0,1,1,1];
						let dy = [-1,0,1,-1,1,-1,0,1];
						let leftMine = this.gameBoard[row][col].elem;//ç©å®¶çœ¼ä¸­å‰©ä½™çš„ç‚¸å¼¹æ•°
						for(var i = 0;i < 8;i++){
							let tx = row + dx[i];
							let ty = col + dy[i];
							if(tx < 0 || tx >= this.row)
								continue;
							if(ty < 0 || ty >= this.col)
								continue;
							if(this.stateBoard[tx][ty].state === 2)
								leftMine--;
						}
						if(leftMine === 0){
							for(let i = 0;i < 8;i++){
								let tx = row + dx[i];
								let ty = col + dy[i];
								this.ClickLeft(tx, ty);
							}
						}
					},
					startTimeCounter:function(){
						this.startTime = new Date().getTime();
						this.TimeCounterId = setInterval(() => {
							this.useTime =  new Date().getTime() - this.startTime;
						}, 100);
					},
					changeMode:function(){
						this.ModeFlag = !this.ModeFlag;
					},
					sendAll:function (messageType, context){
						this.$emit
						(
								"sendall",
								messageType,
								context
						)
					},
					winAction:function(){
						this.gameOverAction(gameWin);
					},
					loseAction:function(){
						this.gameOverAction(gameLose);
					},
					gameOverAction:function (state){
						let changeState = 0;
						let gameResultShow = "";
						if (state === gameWin) {
							changeState = 2;
							gameResultShow = "WIN!";
						}
						if (state === gameLose) {
							changeState = 1;
							gameResultShow = "LOSE!"
						}
						for (let i = 0; i < this.row; i++) {
							for (let j = 0; j < this.col; j++) {
								if (this.stateBoard[i][j].state === 0 && this.gameBoard[i][j].elem === -1) {
									this.stateBoard[i][j].state = changeState;
								}
							}
						}
						clearInterval(this.TimeCounterId);
						this.TimeCounterId = null;
						let postUrl;
						let ScoreVoToServer = {
							gameResult: state,
							boardLevel: this.boardLevel,
							openBoardNumber: this.total - this.totalLeft,
							totalBoardNumber: this.total,
							killMineNumber: this.mineNumber - this.leftMineNumberTrue,
							totalMineNumber: this.mineNumber,
							useTime: this.useTime
						}
						let dofunction;
						if(this.isOnlineBattle) {
							postUrl = '/result/getScoreWithNoRankChange';
							const that = this;
							dofunction = function (result){
								let ScoreVo =
								{
									gameResult:result.body.gameResult,
									winLoseScore: result.body.winLoseScore,
									mineScore: result.body.mineScore,
									timeScore: result.body.timeScore,
									boardScore: result.body.boardScore,
									totalScore: result.body.totalScore
								};
								let Context = JSON.stringify(ScoreVo);
								that.sendAll(messageType.PushOnlineBattleScore, Context);
								that.$emit("loadwaitingforendbattleonline");
								//TODO ç”Ÿæˆç­‰å¾…å¹•å¸ƒ ç­‰å¾…å¯¹æ‰‹å®Œæ¯•
							};
						}
						else {
							postUrl = '/result/getScore';
							const that = this;
							dofunction = function (result){
								let Context = "[" + that.username + "]ä¸ªäººç­‰çº§åˆ†" + result.body.originalRank
										+ "->" + result.body.newRank + "(" + (result.body.rankFloat >= 0 ? '+' : '')
										+ result.body.rankFloat + ")";
								that.sendAll(messageType.UserRankChanged, Context);
								//å»¶è¿Ÿ1000æ¯«ç§’æ‰§è¡Œ
								setTimeout(function () {
									that.$router.push({
										name: 'gameresult',
										params:
										{
											gameResult: gameResultShow,
											winLoseScore: result.body.winLoseScore,
											mineScore: result.body.mineScore,
											timeScore: result.body.timeScore,
											boardScore: result.body.boardScore,
											totalScore: result.body.totalScore,
											originalRank: result.body.originalRank,
											newRank: result.body.newRank,
											rankFloat: result.body.rankFloat
										}
									})
								}, 1000);
							};
						}

						this.$http.post(postUrl,
						ScoreVoToServer)
						.then(function (result) {
							dofunction(result);
						});
					}
				},
				filters:{
					showItem:function(trueValue, rowIndex, colIndex, stateBoard){
						//0æœªè¢«ç‚¹å¼€ 1è¢«ç‚¹å¼€ 2ä¿æŠ¤
						if(stateBoard[rowIndex][colIndex].state === 0)
							return " ";
						if(stateBoard[rowIndex][colIndex].state === 2)
							return "ğŸš©";
						if(trueValue === -1)
							return "ğŸ’£";
						if(trueValue === 0)
							return " ";
						return trueValue;
					}
				},
				watch:{
					'gameState':function(newVal, oldVal){
						if(newVal === gameState.lose){
							this.loseAction();
						}
						if(newVal === gameState.win){
							this.winAction();
						}
					},
					'ModeFlag':function(newVal, oldVal){
						if(newVal){
							this.CurrentMsg = "æ‰«é›·";
						}
						else{
							this.CurrentMsg = "æ’æ——";
						}
					}
				}
			};

			var routerObj = new VueRouter({
				routes:[
					{path:"/",redirect:"/gamestart"},
					{path:"/game",name:"game",component:gameboard},
					{path:"/gamestart",component:gamestart},
					{path:"/gameresult",name:"gameresult" ,component:gameresult},
					{path:"/onlineGameResult",name:"onlineGameResult" ,component:onlineGameResult}
					//{path:"/gameresult",name:"gameresult" ,component:gameresult}

					//onlineGameResult
				]
			});
			
			var vm = new Vue({
				el:'#app',
				data:{
					username:"",
					rankOwn:"",
					rankBattle:"",
					webSocket:null,
					systemNotice:"",
					onlinePersonNumber:0,
					winNumber:0,
					loseNumber:0,
					gameNumber:0,
					battleWinNumber:0,
					battleLoseNumber:0,
					battleGameNumber:0,
					winRate:0,
					battleWinRate:0,
					layerLoadIndex:null,
					outOfTimeAction:null
				},
				components: {

				},
				methods: {
					getUserData:function (){
						this.$http.post('/getUserData',{}).then(
							function (result){
								this.username = result.body.username;
								this.rankOwn = result.body.rankOwn;
								this.rankBattle = result.body.rankBattle;
								this.winNumber = result.body.winNumber;
								this.loseNumber = result.body.loseNumber;
								this.gameNumber = result.body.gameNumber;
								this.battleWinNumber = result.body.battleWinNumber;
								this.battleLoseNumber = result.body.battleLoseNumber;
								this.battleGameNumber = result.body.battleGameNumber;
								if(result.body.gameNumber > 0)
									this.winRate = result.body.winNumber * 100 / result.body.gameNumber;
								if(result.body.battleGameNumber > 0)
									this.battleWinRate = result.body.battleWinNumber * 100 / result.body.battleGameNumber;
								if ("WebSocket" in window) {
									if (this.webSocket === null) {
										this.webSocket = new WebSocket("ws://localhost:8080/webSocket/" + this.username);
										this.webSocket.onopen = function () {
											console.log("å·²ç»è¿é€šäº†websocket");
										};
										let that = this;
										this.webSocket.onmessage = function (evt) {
											let received_msg = evt.data;
											let obj = JSON.parse(received_msg);
											let MessageType = obj.MessageType;
											console.log(MessageType, obj.Context);
											switch (MessageType){
												case messageType.NormalNotice:
												case messageType.UserRankChanged:
													that.systemNotice = obj.Context;
													break;
												case messageType.PersonNumberNotice:
													that.onlinePersonNumber = obj.Context;
													break;
												case messageType.ForceOutOfLine:
													alert(obj.Context);
													document.location = 'http://localhost:8080'
													break;
												case messageType.MatchSucceeded:
													$('.loadInfo').text("åŒ¹é…æˆåŠŸ");
													clearTimeout(that.outOfTimeAction);
													that.outOfTimeAction = null;
													setTimeout(function (){
														console.log(obj);
														console.log(obj.Context);
														let battleUserVo = JSON.parse(obj.Context);
														let username1p = battleUserVo.username1p;
														let username2p = battleUserVo.username2p;
														let rankBattle1p = battleUserVo.rankBattle1p;
														let rankBattle2p = battleUserVo.rankBattle2p;
														let notice = "[" + username1p + "]å’Œ["+ username2p +"]å¼€å§‹å¯¹å±€"
														that.systemNotice = notice;
														layer.close(that.layerLoadIndex);

														that.$router.push({name:'game',
															params:
															{
																isOnlineBattle:true,
																boardLevel:Math.floor((rankBattle1p + rankBattle2p) * 0.75),
																username1p:username1p,
																username2p:username2p
															}
														})
													},1000);
													break;
												case messageType.GetOnlineBattleScoreFromServer:
													console.log(333);
													let OnlineBattleScoreVo = JSON.parse(obj.Context);
													console.log(OnlineBattleScoreVo);
													that.$http.post("/result/getBattleScore", OnlineBattleScoreVo).then(function (result){
														console.log(111);
														layer.close(that.layerLoadIndex);
														clearTimeout(that.outOfTimeAction);
														that.outOfTimeAction = null;
														that.$router.push({name:'onlineGameResult',
															params: OnlineBattleScoreVo
														})
													});
													console.log(222);
													break;
											}
										};

										this.webSocket.onclose = function () {
											console.log("è¿æ¥å·²å…³é—­...");
										};

									}
								}
								else {
									alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebSocket!");
								}

							}
						)
					},
					sendAll:function (messageType, context, showContext){
						var message = {
							"MessageType": messageType,
							"Context": context,
						};
						if(showContext){
							this.systemNotice = context;
						}
						this.webSocket.send(JSON.stringify(message));
					},
					loadWaitingForStartBattle:function (){
						this.layerLoadIndex = layer.load(0, {
							shade: [0.8, "#7F7F00"],
							time: 60*1000,
							content:'<div style="width: 400px;height: 200px;margin-left: -300px;position: relative">'
									+ '<div style="top:-25px;position: absolute"><p class="loadInfo" style="font-size: 60px; text-align: left;">' + 'åŒ¹é…å¯¹æ‰‹ä¸­'+ '</p></div>' +
									'</div>'
						});
						let that = this;
						this.outOfTimeAction = setTimeout(function (){
							that.sendAll(messageType.ClientGetMatchOutOfTime, "");
							layer.msg("åŒ¹é…è¶…æ—¶!");
						},60000);
					},
					loadWaitingForEndBattleOnline:function (){
						this.layerLoadIndex = layer.load(0, {
							shade: [0.8, "#7F7F00"],
							time: 600*1000,
							content:'<div style="width: 400px;height: 200px;margin-left: -400px;position: relative">'
									+ '<div style="top:-25px;position: absolute"><p class="loadInfo" style="font-size: 60px; text-align: left;">' + 'å¯¹æ‰‹è¿˜åœ¨è¿›è¡Œä¸­'+ '</p></div>' +
									'</div>'
						});
						//let that = this;
						this.outOfTimeAction = setTimeout(function (){
							//that.sendAll(messageType.ClientGetMatchOutOfTime, "");
							layer.msg("å¯¹æ–¹ç½‘ç»œä¸ä½³ï¼Œä½ å–å¾—èƒœåˆ©!");
						},600*1000);
					},
				},
				mounted:function (){
					this.getUserData();
				},
				watch: {
					$route(to, from){
						this.getUserData();
					}
				},
				router:routerObj
			});
		</script>
	</body>
</html>
